<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de Bord - Dar Hassna</title>
  <style>
    /* أنماط لوحة التحكم */
    .status-select {
      background-color: white;
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 4px;
    }
    .status-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-preparing { background-color: #cce5ff; color: #004085; }
    .status-ready { background-color: #d4edda; color: #155724; }
    .status-delivered { background-color: #e2e3e5; color: #383d41; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Commandes - Dar Hassna</h1>
    
    <div id="ordersContainer">
      <!-- سيتم ملؤها بالطلبات -->
    </div>

    <div id="loading">
      <img src="https://i.gifer.com/ZZ5H.gif" width="50" alt="Chargement...">
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDpSF4J0bsd6T0ImMpse0KQQRADaxiYUQw",
      authDomain: "darhassna-484c3.firebaseapp.com",
      databaseURL: "https://darhassna-484c3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "darhassna-484c3",
      storageBucket: "darhassna-484c3.firebasestorage.app",
      messagingSenderId: "141393162149",
      appId: "1:141393162149:web:0717227eac221f5ddfc24c"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    async function updateOrderStatus(orderId, newStatus) {
      showLoading(true);
      try {
        await database.ref(`commandes/${orderId}/statut`).set(newStatus);
        console.log("Statut mis à jour avec succès");
        return true;
      } catch (error) {
        console.error("Erreur de mise à jour:", error);
        alert("Erreur: " + error.message);
        return false;
      } finally {
        showLoading(false);
      }
    }

    function displayOrders(orders) {
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';

      Object.entries(orders).forEach(([id, order]) => {
        const orderElement = document.createElement('div');
        orderElement.className = 'order-card';
        orderElement.innerHTML = `
          <div>
            <h3>Table ${order.table}</h3>
            <span class="status-badge status-${order.statut.replace(' ', '')}">
              ${order.statut}
            </span>
            <select class="status-select" data-order-id="${id}">
              <option value="en attente" ${order.statut === 'en attente' ? 'selected' : ''}>En attente</option>
              <option value="en préparation" ${order.statut === 'en préparation' ? 'selected' : ''}>En préparation</option>
              <option value="prêt" ${order.statut === 'prêt' ? 'selected' : ''}>Prêt</option>
              <option value="livré" ${order.statut === 'livré' ? 'selected' : ''}>Livré</option>
            </select>
            <button class="update-btn" data-order-id="${id}">Mettre à jour</button>
          </div>
        `;
        container.appendChild(orderElement);
      });

      document.querySelectorAll('.update-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const orderId = this.getAttribute('data-order-id');
          const statusSelect = document.querySelector(`.status-select[data-order-id="${orderId}"]`);
          const newStatus = statusSelect.value;
          
          await updateOrderStatus(orderId, newStatus);
        });
      });
    }

    function loadOrders() {
      showLoading(true);
      database.ref('commandes').once('value')
        .then(snapshot => {
          const orders = snapshot.val();
          if (orders) {
            displayOrders(orders);
          } else {
            document.getElementById('ordersContainer').innerHTML = '<p>Aucune commande trouvée</p>';
          }
        })
        .catch(error => {
          console.error("Erreur de chargement:", error);
        })
        .finally(() => {
          showLoading(false);
        });
    }

    // Écoute des modifications en temps réel
    database.ref('commandes').on('value', (snapshot) => {
      const orders = snapshot.val();
      if (orders) {
        displayOrders(orders);
      }
    });

    // Chargement initial
    loadOrders();
  </script>
</body>
</html>
