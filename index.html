<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - Dar Hassna</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #d35400;
      text-align: center;
      margin-bottom: 30px;
    }
    .commandes-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .commande-card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      width: 300px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .commande-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .table-num {
      font-weight: bold;
      font-size: 1.2em;
      color: #d35400;
    }
    .commande-time {
      font-size: 0.8em;
      color: #777;
    }
    .commande-status {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-preparing {
      background-color: #cce5ff;
      color: #004085;
    }
    .status-ready {
      background-color: #d4edda;
      color: #155724;
    }
    .commande-items {
      margin-top: 10px;
    }
    .commande-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #eee;
    }
    .item-quantity {
      font-weight: bold;
      margin-right: 5px;
    }
    .commande-total {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .commande-actions {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
    }
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .prepare-btn {
      background-color: #ffc107;
      color: #856404;
    }
    .ready-btn {
      background-color: #28a745;
      color: white;
    }
    .complete-btn {
      background-color: #17a2b8;
      color: white;
    }
    .filter-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .filter-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #e9ecef;
    }
    .filter-btn.active {
      background-color: #d35400;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Commandes en Cours - Dar Hassna</h1>
    
    <div class="filter-container">
      <button class="filter-btn active" data-status="all">Toutes</button>
      <button class="filter-btn" data-status="pending">En attente</button>
      <button class="filter-btn" data-status="preparing">En préparation</button>
      <button class="filter-btn" data-status="ready">Prêtes</button>
    </div>
    
    <div class="commandes-container" id="commandesList">
      <!-- Les commandes seront ajoutées ici dynamiquement -->
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Configuration Firebase (identique à la page de commande)
    const firebaseConfig = {
      apiKey: "AIzaSyDpSF4J0bsd6T0ImMpse0KQQRADaxiYUQw",
      authDomain: "darhassna-484c3.firebaseapp.com",
      databaseURL: "https://darhassna-484c3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "darhassna-484c3",
      storageBucket: "darhassna-484c3.firebasestorage.app",
      messagingSenderId: "141393162149",
      appId: "1:141393162149:web:0717227eac221f5ddfc24c"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Référence à la base de données
    const commandesRef = database.ref('commandes');
    
    // Écouter les nouvelles commandes et les modifications
    commandesRef.on('value', (snapshot) => {
      const commandesList = document.getElementById('commandesList');
      commandesList.innerHTML = '';
      
      snapshot.forEach((childSnapshot) => {
        const commande = childSnapshot.val();
        const commandeId = childSnapshot.key;
        
        // Formater la date
        const date = new Date(commande.timestamp);
        const timeString = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        // Créer la carte de commande
        const commandeCard = document.createElement('div');
        commandeCard.className = 'commande-card';
        commandeCard.dataset.status = commande.statut || 'pending';
        
        // Déterminer la classe de statut
        let statusClass = 'status-pending';
        let statusText = 'En attente';
        if (commande.statut === 'preparing') {
          statusClass = 'status-preparing';
          statusText = 'En préparation';
        } else if (commande.statut === 'ready') {
          statusClass = 'status-ready';
          statusText = 'Prête';
        }
        
        // Générer le HTML des articles
        let itemsHTML = '';
        let total = 0;
        commande.commandes.forEach((item) => {
          const itemTotal = item.quantite * item.prix;
          total += itemTotal;
          itemsHTML += `
            <div class="commande-item">
              <div><span class="item-quantity">${item.quantite}x</span> ${item.plat}</div>
              <div>${itemTotal} MAD</div>
            </div>
          `;
        });
        
        // Remplir la carte de commande
        commandeCard.innerHTML = `
          <div class="commande-header">
            <div class="table-num">Table ${commande.table}</div>
            <div class="commande-time">${timeString}</div>
          </div>
          <div class="commande-status ${statusClass}">${statusText}</div>
          <div class="commande-items">${itemsHTML}</div>
          <div class="commande-total">Total: ${total} MAD</div>
          <div class="commande-actions">
            ${commande.statut === 'pending' ? 
              `<button class="action-btn prepare-btn" data-id="${commandeId}">En Préparation</button>` : ''}
            ${commande.statut === 'preparing' ? 
              `<button class="action-btn ready-btn" data-id="${commandeId}">Prête à Servir</button>` : ''}
            ${commande.statut === 'ready' ? 
              `<button class="action-btn complete-btn" data-id="${commandeId}">Terminer</button>` : ''}
          </div>
        `;
        
        commandesList.appendChild(commandeCard);
      });
      
      // Ajouter les événements aux boutons
      document.querySelectorAll('.prepare-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'preparing'));
      });
      document.querySelectorAll('.ready-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'ready'));
      });
      document.querySelectorAll('.complete-btn').forEach(btn => {
        btn.addEventListener('click', () => removeCommande(btn.dataset.id));
      });
    });
    
    // Fonction pour mettre à jour le statut d'une commande
    function updateStatus(commandeId, newStatus) {
      database.ref(`commandes/${commandeId}`).update({
        statut: newStatus
      });
    }
    
    // Fonction pour supprimer une commande terminée
    function removeCommande(commandeId) {
      database.ref(`commandes/${commandeId}`).remove();
    }
    
    // Filtrage des commandes
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Mettre à jour les boutons de filtre
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const status = this.dataset.status;
        const commandes = document.querySelectorAll('.commande-card');
        
        commandes.forEach(commande => {
          if (status === 'all') {
            commande.style.display = 'block';
          } else {
            commande.style.display = commande.dataset.status === status ? 'block' : 'none';
          }
        });
      });
    });
  </script>
</body>
</html>
